# æ¸¸æˆå¼•æ“æ ¸å¿ƒ - ç®¡ç†æ¸¸æˆä¸»å¾ªç¯ã€åœºæ™¯åˆ‡æ¢ã€å­˜æ¡£ç³»ç»Ÿ

classes:
  GameState:
    # æ¸¸æˆçŠ¶æ€ç®¡ç†
    init: () => {
        this.scenes = {}              # åœºæ™¯å­—å…¸ {id: Scene}
        this.current_scene_id = null
        this.player = null
        this.game_over = false
        this.victory = false
        this.variables = {}           # æ¸¸æˆå˜é‡
        this.flags = {}               # æ¸¸æˆæ ‡å¿—
        this.play_time = 0            # æ¸¸æˆæ—¶é—´ï¼ˆç§’ï¼‰
        this.start_time = time.now()
        this.save_slot = 1
      }
    
    # æ³¨å†Œåœºæ™¯
    register_scene: (scene) => {
        this.scenes[scene.id] = scene
      }
    
    # è·å–åœºæ™¯
    get_scene: (scene_id) => {
        if (scene_id in this.scenes) :
          return this.scenes[scene_id]
        return null
      }
    
    # åˆ‡æ¢åœºæ™¯
    change_scene: (scene_id) => {
        if (!(scene_id in this.scenes)) :
          echo "é”™è¯¯ï¼šåœºæ™¯ '" + scene_id + "' ä¸å­˜åœ¨"
          return false
        
        # ç¦»å¼€å½“å‰åœºæ™¯
        if (this.current_scene_id != null) :
          current = this.get_scene(this.current_scene_id)
          if (current != null) :
            current.exit(this.player, this)
        
        # åˆ‡æ¢åœºæ™¯
        this.current_scene_id = scene_id
        new_scene = this.get_scene(scene_id)
        
        # è¿›å…¥æ–°åœºæ™¯
        new_scene.enter(this.player, this)
        
        return true
      }
    
    # è®¾ç½®å˜é‡
    set_var: (key, value) => {
        this.variables[key] = value
      }
    
    # è·å–å˜é‡
    get_var: (key, default_val) => {
        if (key in this.variables) :
          return this.variables[key]
        return default_val
      }
    
    # è®¾ç½®æ ‡å¿—
    set_flag: (flag, value) => {
        if (value == null) :
          value = true
        this.flags[flag] = value
      }
    
    # æ£€æŸ¥æ ‡å¿—
    check_flag: (flag) => {
        if (flag in this.flags) :
          return this.flags[flag]
        return false
      }
    
    # è·å–æ¸¸æˆæ—¶é—´
    get_play_time: () => {
        current = time.now()
        elapsed = current - this.start_time
        return elapsed
      }
    
    # æ ¼å¼åŒ–æ¸¸æˆæ—¶é—´
    format_play_time: () => {
        total_seconds = this.get_play_time()
        hours = int(total_seconds / 3600)
        minutes = int((total_seconds % 3600) / 60)
        seconds = int(total_seconds % 60)
        
        result = ""
        if (hours > 0) :
          result = result + str(hours) + "å°æ—¶"
        if (minutes > 0 || hours > 0) :
          result = result + str(minutes) + "åˆ†é’Ÿ"
        result = result + str(seconds) + "ç§’"
        return result
      }

  SaveManager:
    # å­˜æ¡£ç®¡ç†å™¨
    init: (game_state) => {
        this.game_state = game_state
        this.save_dir = "saves"
      }
    
    # åˆ›å»ºå­˜æ¡£æ•°æ®
    create_save_data: () => {
        player = this.game_state.player
        
        # ä¿å­˜ç©å®¶æ•°æ®
        save_data = {
          "player": {
            "name": player.name,
            "level": player.level,
            "exp": player.exp,
            "exp_to_next": player.exp_to_next,
            "hp": player.hp,
            "max_hp": player.max_hp,
            "mp": player.mp,
            "max_mp": player.max_mp,
            "strength": player.strength,
            "agility": player.agility,
            "intelligence": player.intelligence,
            "vitality": player.vitality,
            "status": player.status,
            "location": player.location,
            "inventory_gold": player.inventory.gold,
            "stats": player.stats
          },
          "current_scene": this.game_state.current_scene_id,
          "variables": this.game_state.variables,
          "flags": this.game_state.flags,
          "play_time": this.game_state.get_play_time(),
          "timestamp": time.now()
        }
        
        return save_data
      }
    
    # ä¿å­˜æ¸¸æˆ
    save: (slot) => {
        if (slot == null) :
          slot = this.game_state.save_slot
        
        try :
          save_data = this.create_save_data()
          filename = "save_" + str(slot) + ".json"
          json_str = json.stringify(save_data, 2)
          
          # ç¡®ä¿å­˜æ¡£ç›®å½•å­˜åœ¨
          if (!io.file_exists(this.save_dir)) :
            io.create_dir(this.save_dir)
          
          filepath = this.save_dir + "/" + filename
          io.write_file(filepath, json_str)
          
          echo "æ¸¸æˆå·²ä¿å­˜åˆ°å­˜æ¡£ " + str(slot)
          return true
        catch (error) :
          echo "ä¿å­˜å¤±è´¥: " + error
          return false
      }
    
    # åŠ è½½æ¸¸æˆ
    load: (slot) => {
        if (slot == null) :
          slot = 1
        
        try :
          filename = "save_" + str(slot) + ".json"
          filepath = this.save_dir + "/" + filename
          
          if (!io.file_exists(filepath)) :
            echo "å­˜æ¡£ " + str(slot) + " ä¸å­˜åœ¨"
            return false
          
          json_str = io.read_file(filepath)
          save_data = json.parse(json_str)
          
          # æ¢å¤æ¸¸æˆçŠ¶æ€
          this.restore_save_data(save_data)
          
          echo "æ¸¸æˆå·²ä»å­˜æ¡£ " + str(slot) + " åŠ è½½"
          return true
        catch (error) :
          echo "åŠ è½½å¤±è´¥: " + error
          return false
      }
    
    # æ¢å¤å­˜æ¡£æ•°æ®
    restore_save_data: (save_data) => {
        # æ¢å¤ç©å®¶æ•°æ®
        player_data = save_data.player
        player = this.game_state.player
        
        player.name = player_data.name
        player.level = player_data.level
        player.exp = player_data.exp
        player.exp_to_next = player_data.exp_to_next
        player.hp = player_data.hp
        player.max_hp = player_data.max_hp
        player.mp = player_data.mp
        player.max_mp = player_data.max_mp
        player.strength = player_data.strength
        player.agility = player_data.agility
        player.intelligence = player_data.intelligence
        player.vitality = player_data.vitality
        player.status = player_data.status
        player.location = player_data.location
        player.inventory.gold = player_data.inventory_gold
        player.stats = player_data.stats
        
        # æ¢å¤æ¸¸æˆçŠ¶æ€
        this.game_state.current_scene_id = save_data.current_scene
        this.game_state.variables = save_data.variables
        this.game_state.flags = save_data.flags
        this.game_state.start_time = time.now() - save_data.play_time
      }
    
    # åˆ—å‡ºæ‰€æœ‰å­˜æ¡£
    list_saves: () => {
        saves = []
        for (slot in range(1, 6)) :
          filename = "save_" + str(slot) + ".json"

          filepath = this.save_dir + "/" + filename
          if (io.file_exists(filepath)) :
            try :
              json_str = io.read_file(filepath)
              save_data = json.parse(json_str)
              timestamp = save_data.timestamp
              formatted_time = time.format(timestamp, "%Y-%m-%d %H:%M:%S")
              saves = saves + ["å­˜æ¡£ " + str(slot) + ": " + formatted_time + " - " + save_data.player.name + " (Lv." + str(save_data.player.level) + ")"]
            catch (error) :
              saves = saves + ["å­˜æ¡£ " + str(slot) + ": [æŸå]"]
          else :
            saves = saves + ["å­˜æ¡£ " + str(slot) + ": [ç©º]"]
        return saves
      }

  GameEngine:
    # æ¸¸æˆå¼•æ“ä¸»ç±»
    init: () => {
        this.game_state = GameState()
        this.save_manager = SaveManager(this.game_state)
        this.running = false
        this.debug_mode = false
      }
    
    # åˆå§‹åŒ–æ¸¸æˆ
    initialize: (player_name) => {
        # åˆ›å»ºç©å®¶
        player = Player(player_name)
        this.game_state.player = player
        
        echo ""
        echo "æ¬¢è¿, " + player_name + "!"
        echo "ä½ çš„å†’é™©å³å°†å¼€å§‹..."
        echo ""
        
        input_handler.pause()
      }
    
    # æ³¨å†Œåœºæ™¯
    register_scene: (scene) => {
        this.game_state.register_scene(scene)
      }
    
    # è®¾ç½®èµ·å§‹åœºæ™¯
    set_start_scene: (scene_id) => {
        this.game_state.change_scene(scene_id)
      }
    
    # æ¸¸æˆä¸»å¾ªç¯
    run: () => {
        this.running = true
        
        while (this.running) :
          # æ£€æŸ¥æ¸¸æˆç»“æŸæ¡ä»¶
          if (this.game_state.game_over) :
            this.show_game_over()
            break
          
          if (this.game_state.victory) :
            this.show_victory()
            break
          
          # è·å–å½“å‰åœºæ™¯
          current_scene = this.game_state.get_scene(this.game_state.current_scene_id)
          if (current_scene == null) :
            echo "é”™è¯¯ï¼šå½“å‰åœºæ™¯æ— æ•ˆ"
            break
          
          # æ˜¾ç¤ºåœºæ™¯
          formatter.clear_screen()
          available_choices = current_scene.display(this.game_state.player, this.game_state)
          
          # æ˜¾ç¤ºç©å®¶çŠ¶æ€æ 
          this.show_status_bar()
          
          # è·å–ç©å®¶é€‰æ‹©
          echo ""
          echo "è¯·è¾“å…¥é€‰é¡¹ç¼–å· (æˆ–è¾“å…¥ Sä¿å­˜ LåŠ è½½ IèƒŒåŒ… Qé€€å‡º): "
          input_str = input()
          
          # å¤„ç†ç‰¹æ®Šå‘½ä»¤
          if (input_str == "Q" || input_str == "q") :
            if (input_handler.get_confirm("ç¡®å®šè¦é€€å‡ºæ¸¸æˆå—? (Y/N): ")) :
              this.running = false
              break
            continue
          
          if (input_str == "S" || input_str == "s") :
            this.save_manager.save(null)
            input_handler.pause()
            continue
          
          if (input_str == "L" || input_str == "l") :
            this.show_load_menu()
            continue
          
          if (input_str == "I" || input_str == "i") :
            this.game_state.player.show_inventory()
            input_handler.pause()
            continue
          
          # å¤„ç†åœºæ™¯é€‰æ‹©
          try :
            choice_num = int(input_str)
            if (choice_num >= 1 && choice_num <= len(available_choices)) :
              target_scene = current_scene.make_choice(choice_num - 1, this.game_state.player, this.game_state)
              if (target_scene != null) :
                this.game_state.change_scene(target_scene)
            else :
              echo "æ— æ•ˆé€‰é¡¹"
          catch (error) :
            echo "è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°å­—æˆ–å‘½ä»¤"
          
          input_handler.pause()
      
      echo ""
      echo "æ„Ÿè°¢æ¸¸ç©ï¼"
      echo "æ¸¸æˆæ—¶é—´: " + this.game_state.format_play_time()
    }
    
    # æ˜¾ç¤ºçŠ¶æ€æ 
    show_status_bar: () => {
        player = this.game_state.player
        echo ""
        echo "[" + player.name + " | Lv." + str(player.level) + " | HP:" + str(player.hp) + "/" + str(player.max_hp) + " | MP:" + str(player.mp) + "/" + str(player.max_mp) + " | é‡‘å¸:" + str(player.inventory.gold) + "]"
        echo "[å‘½ä»¤: Sä¿å­˜ LåŠ è½½ IèƒŒåŒ… Qé€€å‡º]"
    }
    
    # æ˜¾ç¤ºæ¸¸æˆç»“æŸ
    show_game_over: () => {
        formatter.clear_screen()
        formatter.print_title("æ¸¸ æˆ ç»“ æŸ")
        echo ""
        echo "ä½ çš„å†’é™©åˆ°æ­¤ç»“æŸ..."
        echo ""
        echo "æ¸¸æˆæ—¶é—´: " + this.game_state.format_play_time()
        echo ""
        input_handler.pause("æŒ‰å›è½¦é”®é€€å‡º...")
    }
    
    # æ˜¾ç¤ºèƒœåˆ©ç”»é¢
    show_victory: () => {
        formatter.clear_screen()
        formatter.print_title("ğŸ‰ èƒœ åˆ© ğŸ‰")
        echo ""
        echo "æ­å–œä½ å®Œæˆäº†å†’é™©ï¼"
        echo ""
        player = this.game_state.player
        echo "æœ€ç»ˆçŠ¶æ€:"
        player.show_status()
        echo ""
        echo "æ¸¸æˆæ—¶é—´: " + this.game_state.format_play_time()
        echo ""
        input_handler.pause("æŒ‰å›è½¦é”®é€€å‡º...")
    }
    
    # æ˜¾ç¤ºåŠ è½½èœå•
    show_load_menu: () => {
        formatter.clear_screen()
        formatter.print_title("åŠ  è½½ æ¸¸ æˆ")
        echo ""
        
        saves = this.save_manager.list_saves()
        for (i in range(len(saves))) :
          echo "  " + saves[i]

        
        echo ""
        echo "  [0] è¿”å›"
        echo ""
        
        slot = input_handler.get_int("è¯·é€‰æ‹©è¦åŠ è½½çš„å­˜æ¡£ (0-5): ", 0, 5)
        if (slot > 0) :
          this.save_manager.load(slot)
    }
    
    # æ˜¾ç¤ºä¸»èœå•
    show_main_menu: () => {
        while (true) :
          formatter.clear_screen()
          formatter.print_title("HPL æ–‡å­—æ¸¸æˆæ¡†æ¶")
          echo ""
          echo "  [1] å¼€å§‹æ–°æ¸¸æˆ"
          echo "  [2] åŠ è½½æ¸¸æˆ"
          echo "  [3] é€€å‡º"
          echo ""
          
          choice = input_handler.get_int("è¯·é€‰æ‹©: ", 1, 3)
          
          if (choice == 1) :
            return "new"
          if (choice == 2) :
            return "load"
          if (choice == 3) :
            return "exit"
      }
    
    # ä»å­˜æ¡£ç»§ç»­æ¸¸æˆ
    continue_from_save: (slot) => {
        if (this.save_manager.load(slot)) :
          # æ¢å¤åç»§ç»­æ¸¸æˆå¾ªç¯
          this.run()
          return true
        return false
      }

objects:
  game_engine: GameEngine()
