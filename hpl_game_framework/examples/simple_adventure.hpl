# ç®€å•å†’é™©æ¸¸æˆç¤ºä¾‹ - å±•ç¤ºHPLæ–‡å­—æ¸¸æˆæ¡†æ¶çš„åŸºæœ¬ç”¨æ³•

includes:
  - ../utils/game_utils.hpl
  - ../utils/interaction.hpl
  - ../core/player.hpl
  - ../core/scene.hpl
  - ../core/game_engine.hpl

imports:
  - time
  - json
  - io

classes:
  AdventureGame:
    # å†’é™©æ¸¸æˆç±»
    init: () => {
        this.engine = GameEngine()
        this.setup_scenes()
      }
    
    # è®¾ç½®æ¸¸æˆåœºæ™¯
    setup_scenes: () => {
        # åœºæ™¯1: èµ·å§‹æ‘åº„
        village = Scene("village", "å®é™æ‘åº„", "ä½ ç«™åœ¨ä¸€ä¸ªå®é™çš„å°æ‘åº„ä¸­å¤®ã€‚å‘¨å›´æ˜¯å‡ é—´èŒ…è‰å±‹ï¼Œæ‘æ°‘ä»¬å¿™ç¢Œåœ°èµ°æ¥èµ°å»ã€‚æ‘å­çš„ä¸œè¾¹æœ‰ä¸€ç‰‡èŒ‚å¯†çš„æ£®æ—ï¼Œè¥¿è¾¹æ˜¯ä¸€æ¡é€šå¾€å±±è„‰çš„å°è·¯ã€‚")
        
        # æ·»åŠ é€‰æ‹©é¡¹
        village.add_simple_choice("å‰å¾€æ£®æ—", "forest")
        village.add_simple_choice("å‰å¾€å±±è„‰", "mountain")
        village.add_simple_choice("ä¸æ‘æ°‘äº¤è°ˆ", "village_talk")
        village.add_simple_choice("æŸ¥çœ‹çŠ¶æ€", "check_status")
        
        # åœºæ™¯2: æ£®æ—å…¥å£
        forest = Scene("forest", "æ£®æ—å…¥å£", "ä½ æ¥åˆ°äº†æ£®æ—çš„è¾¹ç¼˜ã€‚é«˜å¤§çš„æ ‘æœ¨é®å¤©è”½æ—¥ï¼Œæ—é—´ä¼ æ¥å¥‡æ€ªçš„å£°å“ã€‚ä½ æ³¨æ„åˆ°åœ°ä¸Šæœ‰ä¸€äº›è„šå°ï¼Œä¼¼ä¹æœ‰äººæœ€è¿‘æ¥è¿‡è¿™é‡Œã€‚")
        
        forest.add_simple_choice("æ·±å…¥æ£®æ—", "deep_forest")
        forest.add_simple_choice("è¿”å›æ‘åº„", "village")
        forest.add_simple_choice("æœç´¢å‘¨å›´", "search_forest")
        
        # åœºæ™¯3: æ£®æ—æ·±å¤„
        deep_forest = Scene("deep_forest", "æ£®æ—æ·±å¤„", "æ£®æ—è¶Šæ¥è¶Šå¯†ï¼Œå…‰çº¿å˜å¾—æ˜æš—ã€‚çªç„¶ï¼Œä½ å¬åˆ°äº†ä¸€å£°ä½å¼ï¼ä¸€åªé‡ç‹¼ä»çŒæœ¨ä¸›ä¸­è·³äº†å‡ºæ¥ï¼")
        
        deep_forest.add_simple_choice("æˆ˜æ–—ï¼", "combat_wolf")
        deep_forest.add_simple_choice("é€ƒè·‘", "flee_forest")
        
        # åœºæ™¯4: å±±è„‰å°è·¯
        mountain = Scene("mountain", "å±±è„‰å°è·¯", "å±±è·¯å´å²–éš¾è¡Œï¼Œä½†ä½ çœ‹åˆ°äº†è¿œå¤„å±±é¡¶ä¸Šæœ‰ä¸€åº§å¤è€çš„å¡”ã€‚è·¯è¾¹æœ‰ä¸€ä¸ªå•†äººæ­£åœ¨æ‘†æ‘Šã€‚")
        
        mountain.add_simple_choice("å‰å¾€å¤å¡”", "tower")
        mountain.add_simple_choice("ä¸å•†äººäº¤æ˜“", "merchant")
        mountain.add_simple_choice("è¿”å›æ‘åº„", "village")
        
        # åœºæ™¯5: å¤å¡”
        tower = Scene("tower", "ç¥ç§˜å¤å¡”", "ä½ æ¥åˆ°äº†å¤å¡”å‰ã€‚å¡”é—¨ç´§é—­ï¼Œä¸Šé¢åˆ»ç€å¥‡æ€ªçš„ç¬¦æ–‡ã€‚ä½ æ„Ÿè§‰åˆ°è¿™é‡Œéšè—ç€ä»€ä¹ˆç§˜å¯†...")
        
        tower.add_simple_choice("å°è¯•å¼€é—¨", "open_tower")
        tower.add_simple_choice("è¿”å›", "mountain")
        
        # åœºæ™¯6: èƒœåˆ©
        victory = Scene("victory", "å†’é™©å®Œæˆ", "ä½ æˆåŠŸè§£å¼€äº†å¤å¡”çš„ç§˜å¯†ï¼ä¸€é“é‡‘å…‰é—ªè¿‡ï¼Œä½ å‘ç°è‡ªå·±è·å¾—äº†ä¼ è¯´ä¸­çš„å®è—ã€‚æ­å–œä½ å®Œæˆäº†å†’é™©ï¼")
        
        # æ³¨å†Œæ‰€æœ‰åœºæ™¯
        this.engine.register_scene(village)
        this.engine.register_scene(forest)
        this.engine.register_scene(deep_forest)
        this.engine.register_scene(mountain)
        this.engine.register_scene(tower)
        this.engine.register_scene(victory)
        
        # è®¾ç½®èµ·å§‹åœºæ™¯
        this.engine.set_start_scene("village")
      }
    
    # å¼€å§‹æ¸¸æˆ
    start: () => {
        formatter.clear_screen()
        formatter.print_title("ç®€ å• å†’ é™© æ¸¸ æˆ")
        echo ""
        echo "è¿™æ˜¯ä¸€ä¸ªä½¿ç”¨HPLæ–‡å­—æ¸¸æˆæ¡†æ¶åˆ›å»ºçš„ç¤ºä¾‹æ¸¸æˆã€‚"
        echo ""
        
        # æ˜¾ç¤ºä¸»èœå•
        menu_choice = this.engine.show_main_menu()
        
        if (menu_choice == "exit") :
          echo "å†è§ï¼"
          return
        
        if (menu_choice == "load") :
          # æ˜¾ç¤ºåŠ è½½èœå•
          saves = this.engine.save_manager.list_saves()
          for (i = 0; i < len(saves); i++) :
            echo saves[i]
          
          slot = input_handler.get_int("é€‰æ‹©å­˜æ¡£ (1-5): ", 1, 5)
          if (this.engine.continue_from_save(slot)) :
            return
          # åŠ è½½å¤±è´¥ï¼Œå¼€å§‹æ–°æ¸¸æˆ
        
        # å¼€å§‹æ–°æ¸¸æˆ
        echo ""
        player_name = input_handler.get_string("è¯·è¾“å…¥ä½ çš„åå­—: ", false)
        
        this.engine.initialize(player_name)
        
        # ç»™ç©å®¶ä¸€äº›åˆå§‹ç‰©å“
        player = this.engine.game_state.player
        
        # åˆ›å»ºåˆå§‹ç‰©å“
        potion = Item("healing_potion", "æ²»ç–—è¯æ°´", "æ¢å¤20ç‚¹ç”Ÿå‘½å€¼", "consumable", 10)
        potion.set_stat("heal_amount", 20)
        
        sword = Item("rusty_sword", "ç”Ÿé”ˆçš„å‰‘", "ä¸€æŠŠæ—§å‰‘ï¼Œä½†è¿˜èƒ½ç”¨", "weapon", 15)
        sword.set_stat("attack", 3)
        
        # æ·»åŠ åˆ°èƒŒåŒ…
        player.inventory.add_item(potion)
        player.inventory.add_item(sword)
        player.inventory.equip_item(1)  # è£…å¤‡å‰‘
        
        echo ""
        echo "ä½ è·å¾—äº†ï¼š"
        echo "  - æ²»ç–—è¯æ°´ x1"
        echo "  - ç”Ÿé”ˆçš„å‰‘ x1"
        echo ""
        echo "å‰‘å·²è‡ªåŠ¨è£…å¤‡ã€‚"
        echo ""
        input_handler.pause()
        
        # å¼€å§‹æ¸¸æˆå¾ªç¯
        this.engine.run()
      }

  # æ‰©å±•åœºæ™¯å¤„ç†ç±»
  ExtendedSceneHandler:
    # å¤„ç†ç‰¹æ®Šåœºæ™¯é€»è¾‘
    handle_village_talk: (engine) => {
        dialog_system.show_dialog("æ‘æ°‘", "ä½ å¥½ï¼Œæ—…è¡Œè€…ï¼æœ€è¿‘æ£®æ—é‡Œæœ‰é‡ç‹¼å‡ºæ²¡ï¼Œè¯·å°å¿ƒã€‚å¬è¯´å±±é¡¶çš„å¤å¡”é‡Œæœ‰å®è—ï¼Œä½†æ²¡äººèƒ½æ‰“å¼€é‚£æ‰‡é—¨ã€‚")
        input_handler.pause()
        engine.game_state.change_scene("village")
      }
    
    handle_check_status: (engine) => {
        engine.game_state.player.show_status()
        input_handler.pause()
        engine.game_state.change_scene("village")
      }
    
    handle_search_forest: (engine) => {
        player = engine.game_state.player
        dialog_system.show_narration("ä½ åœ¨æ£®æ—ä¸­ä»”ç»†æœç´¢...")
        
        # éšæœºå‘ç°
        roll = random_gen.random_range(1, 100)
        if (roll <= 30) :
          # å‘ç°è‰è¯
          herb = Item("herb", "è‰è¯", "å¯ä»¥åˆ¶ä½œè¯æ°´çš„æ¤ç‰©", "misc", 5)
          player.inventory.add_item(herb)
          dialog_system.show_loot("è‰è¯", 1)
        else :
          if (roll <= 60) :
            # å‘ç°é‡‘å¸
            gold = random_gen.random_range(5, 20)
            player.inventory.add_gold(gold)
            dialog_system.show_loot("é‡‘å¸", gold)
          else :
            dialog_system.show_narration("ä½ ä»€ä¹ˆä¹Ÿæ²¡æ‰¾åˆ°...")
        
        input_handler.pause()
        engine.game_state.change_scene("forest")
      }
    
    handle_combat_wolf: (engine) => {
        player = engine.game_state.player
        
        dialog_system.show_narration("æˆ˜æ–—å¼€å§‹ï¼")
        
        # åˆ›å»ºé‡ç‹¼
        wolf_hp = 30
        wolf_attack = 8
        
        while (wolf_hp > 0 && player.is_alive()) :
          # æ˜¾ç¤ºæˆ˜æ–—çŠ¶æ€
          echo ""
          echo "=== æˆ˜æ–— ==="
          echo "é‡ç‹¼ HP: " + str(wolf_hp)
          echo "ä½ çš„ HP: " + str(player.hp) + "/" + str(player.max_hp)
          echo ""
          echo "1. æ”»å‡»"
          echo "2. ä½¿ç”¨ç‰©å“"
          echo "3. é€ƒè·‘"
          
          choice = input_handler.get_int("é€‰æ‹©è¡ŒåŠ¨: ", 1, 3)
          
          if (choice == 1) :
            # ç©å®¶æ”»å‡»
            damage = player.get_attack() + random_gen.random_range(1, 6)
            wolf_hp = wolf_hp - damage
            dialog_system.show_combat(player.name, "æ”»å‡»", "é‡ç‹¼", "é€ æˆ " + str(damage) + " ç‚¹ä¼¤å®³")
            
            if (wolf_hp <= 0) :
              break
          
          if (choice == 2) :
            # ä½¿ç”¨ç‰©å“ï¼ˆç®€åŒ–ï¼‰
            echo "ä½ ä½¿ç”¨äº†æ²»ç–—è¯æ°´ï¼"
            player.heal(20)
          
          if (choice == 3) :
            # é€ƒè·‘
            if (random_gen.random_range(1, 100) <= 50) :
              dialog_system.show_narration("ä½ æˆåŠŸé€ƒè·‘äº†ï¼")
              engine.game_state.change_scene("forest")
              return
            else :
              dialog_system.show_narration("é€ƒè·‘å¤±è´¥ï¼")
          
          # é‡ç‹¼æ”»å‡»
          if (wolf_hp > 0) :
            damage = wolf_attack - int(player.get_defense() / 2)
            if (damage < 1) :
              damage = 1
            player.take_damage(damage)
            dialog_system.show_combat("é‡ç‹¼", "æ”»å‡»", player.name, "é€ æˆ " + str(damage) + " ç‚¹ä¼¤å®³")
            
            if (!player.is_alive()) :
              dialog_system.show_narration("ä½ è¢«é‡ç‹¼å‡»è´¥äº†...")
              engine.game_state.game_over = true
              return
        
        # æˆ˜æ–—èƒœåˆ©
        echo ""
        echo "ğŸ‰ æˆ˜æ–—èƒœåˆ©ï¼"
        exp_gain = 25
        gold_gain = random_gen.random_range(10, 30)
        
        player.gain_exp(exp_gain)
        player.inventory.add_gold(gold_gain)
        
        dialog_system.show_loot("ç»éªŒå€¼", exp_gain)
        dialog_system.show_loot("é‡‘å¸", gold_gain)
        
        # æ ‡è®°å·²å‡»è´¥é‡ç‹¼
        engine.game_state.set_flag("wolf_defeated", true)
        
        input_handler.pause()
        engine.game_state.change_scene("deep_forest")
      }
    
    handle_flee_forest: (engine) => {
        dialog_system.show_narration("ä½ è½¬èº«å°±è·‘ï¼Œé‡ç‹¼æ²¡æœ‰è¿½ä¸Šæ¥ã€‚")
        input_handler.pause()
        engine.game_state.change_scene("forest")
      }
    
    handle_merchant: (engine) => {
        player = engine.game_state.player
        
        dialog_system.show_dialog("å•†äºº", "æ¬¢è¿ï¼Œæ¬¢è¿ï¼çœ‹çœ‹æˆ‘æœ‰ä»€ä¹ˆå¥½ä¸œè¥¿å§ï¼")
        echo ""
        echo "1. è´­ä¹°æ²»ç–—è¯æ°´ (10é‡‘å¸)"
        echo "2. å‡ºå”®ç‰©å“"
        echo "3. ç¦»å¼€"
        
        choice = input_handler.get_int("é€‰æ‹©: ", 1, 3)
        
        if (choice == 1) :
          if (player.inventory.spend_gold(10)) :
            potion = Item("healing_potion", "æ²»ç–—è¯æ°´", "æ¢å¤20ç‚¹ç”Ÿå‘½å€¼", "consumable", 10)
            potion.set_stat("heal_amount", 20)
            player.inventory.add_item(potion)
            dialog_system.show_loot("æ²»ç–—è¯æ°´", 1)
          else :
            echo "é‡‘å¸ä¸è¶³ï¼"
          input_handler.pause()
        
        engine.game_state.change_scene("mountain")
      }
    
    handle_open_tower: (engine) => {
        player = engine.game_state.player
        
        # æ£€æŸ¥æ˜¯å¦æœ‰é’¥åŒ™ï¼ˆè¿™é‡Œç®€åŒ–å¤„ç†ï¼‰
        if (player.level >= 2 || engine.game_state.check_flag("wolf_defeated")) :
          dialog_system.show_narration("ä½ ç”¨å°½å…¨åŠ›æ¨å¼€äº†å¤å¡”çš„å¤§é—¨...")
          input_handler.pause()
          engine.game_state.victory = true
          engine.game_state.change_scene("victory")
        else :
          dialog_system.show_narration("é—¨çº¹ä¸ä¸åŠ¨ã€‚ä¹Ÿè®¸ä½ éœ€è¦å˜å¾—æ›´å¼ºï¼Œæˆ–è€…æ‰¾åˆ°æŸç§é’¥åŒ™...")
          input_handler.pause()
          engine.game_state.change_scene("tower")
      }

objects:
  adventure_game: AdventureGame()
  scene_handler: ExtendedSceneHandler()

main: () => {
    # å¯åŠ¨æ¸¸æˆ
    adventure_game.start()
  }

call: main()
