# ========== 场景定义 ==========
scenes:
  # 迷雾森林
  - id: "forest"
    name: "迷雾森林"
    description: |
      你站在一片神秘的森林入口。
      古老的树木高耸入云，雾气在林间缭绕。
      你听到远处传来奇怪的声音。
      东南方隐约可见一座古老遗迹的轮廓，
      西南方则传来沼泽特有的潮湿气息。
    choices:
      - text: "进入洞穴探险"
        target: "cave"
        condition: null
      
      - text: "前往村庄"
        target: "village"
        condition: null
      
      - text: "前往古老遗迹"
        target: "ancient_ruins"
        condition: null
      
      - text: "前往黑暗沼泽"
        target: "dark_swamp"
        condition: null
      
      - text: "在森林中搜索"
        target: null
        action:
          type: random_event
          events:
            - chance: 30
              message: "你在森林中发现了一些草药！"
              give_items: [{id: "herb_001", count: 3}]
              give_gold: 10
            - chance: 20
              message: "你发现了一个被遗弃的包裹！"
              give_items: [{id: "potion_001", count: 1}]
              give_gold: 15
            - chance: 20
              message: "你踩到了一个陷阱！你受了轻伤，失去10点HP"
              damage: 10
            - chance: 30
              message: "你在森林中搜索了一番，但没有发现什么特别的东西。"

      
      - text: "采集月光花（夜间）"
        target: null
        action:
          type: random_event
          events:
            - chance: 40
              message: "你在月光下发现了一朵稀有的月光花！"
              give_items: [{id: "flower_001", count: 1}]
            - chance: 60
              message: "今晚没有找到月光花..."

      
      - text: "查看状态"
        target: null
        action:
          type: show_message
          message: "查看玩家状态..."
          # 注：复杂状态显示仍可用HPL代码块，这里简化为消息提示

    
    on_enter: |
      ui.show_narration("【迷雾森林】")
      ui.show_system("雾气在你身边缭绕，远处传来神秘的声响...")
    
    on_exit: null


  # 幽暗洞穴
  - id: "cave"
    name: "幽暗洞穴"
    description: |
      一个阴暗潮湿的洞穴。
      水滴从洞顶落下，发出滴答声。
      你感觉到有什么东西在黑暗中注视着你。
      洞穴深处似乎还有更深层的通道。
    choices:
      - text: "返回森林"
        target: "forest"
      
      - text: "深入洞穴"
        target: null
        action:
          type: random_event
          events:
            - chance: 40
              message: "你击败了蝙蝠群！获得25经验值！"
              exp: 25
              give_items: [{id: "sword_001", count: 1}]
            - chance: 30
              message: "你击败了洞穴蜘蛛！获得35经验值和20金币！"
              exp: 35
              give_gold: 20
            - chance: 15
              message: "你发现了一个隐藏的宝箱！获得生命药水、魔法药水和50金币！"
              give_items: [{id: "potion_001", count: 1}, {id: "potion_002", count: 1}]
              give_gold: 50
            - chance: 15
              message: "巨型蝙蝠攻击了你，你失去15点HP！"
              damage: 15

      
      - text: "前往洞穴深处"
        target: "deep_cave"
        condition: null
      
      - text: "使用火把搜索"
        target: null
        action:
          type: random_event
          events:
            - chance: 50
              message: "你用火把照亮了洞穴的角落...发现了魔法水晶！"
              give_items: [{id: "crystal_001", count: 1}]
            - chance: 50
              message: "你用火把照亮了洞穴的角落...除了蝙蝠粪便，你什么也没发现..."

    
    on_enter: |
      ui.show_narration("【幽暗洞穴】")
      ui.show_system("这里很暗...你点燃了火把。")
      ui.show_system("你听到翅膀拍打的声音从黑暗中传来...")


  # 宁静村庄
  - id: "village"
    name: "宁静村庄"
    description: |
      一个宁静的小村庄。
      村民们友好地向你打招呼，铁匠铺传来叮叮当当的敲打声。
      村中心有一个公告板，上面贴着各种任务和消息。
      远处可以看到商人营地的帐篷。
    choices:
      - text: "返回森林"
        target: "forest"
      
      - text: "前往商人营地"
        target: "merchant_camp"
        condition: null
      
      - text: "与村民交谈"
        target: null
        action:
          type: sequence
          actions:
            - type: show_message
              msg_type: dialog
              message: "村民：欢迎来到我们的村庄，旅行者！需要休息吗？"
            - type: heal
              amount: 20
              message: "村民为你提供了简单的治疗。"
            - type: show_message
              msg_type: dialog
              message: "村民：如果你需要装备，可以去商人营地看看。"

      
      - text: "访问铁匠铺"
        target: null
        action: |
          ui.show_dialog("铁匠", "我可以帮你修理装备，或者你可以用材料打造新装备。")
          p = engine.get_player(engine_id)
          ui.show_system("铁匠看了看你的材料...")
          # 简单的装备打造逻辑
          ui.show_system("（打造功能需要特定材料）")
      
      - text: "查看公告板"
        target: null
        action: |
          ui.show_system("=== 村庄公告板 ===")
          ui.show_system("【任务】清除洞穴中的怪物 - 奖励：100金币")
          ui.show_system("【消息】黑暗沼泽出现神秘生物，请小心")
          ui.show_system("【悬赏】寻找古老遗迹中的神秘卷轴")
          ui.show_system("==================")
      
      - text: "在村庄中休息（恢复全部HP/MP）"
        target: null
        action:
          type: sequence
          actions:
            - type: show_message
              message: "你在旅馆好好休息了一晚，感觉焕然一新！花费10金币。"
            - type: heal
              amount: 999
            - type: show_message
              message: "HP和MP已完全恢复！"
            # 注：MP恢复和扣费需要扩展处理器，这里简化处理

      
      - text: "在村庄中探索"
        target: null
        action:
          type: random_event
          events:
            - chance: 30
              message: "你在村庄中闲逛，发现了5枚金币！"
              give_gold: 5
            - chance: 20
              message: "一个小孩跑过来给了你一颗糖！（虽然没什么用，但心情变好了）"
            - chance: 50
              message: "你在村庄中逛了逛，没有什么特别的发现。"

    
    on_enter: |
      ui.show_narration("【宁静村庄】")
      ui.show_system("村民们向你微笑致意。")
      ui.show_system("这里是一个安全的休息场所。")

  # 洞穴深处
  - id: "deep_cave"
    name: "洞穴深处"
    description: |
      洞穴的深处更加阴暗潮湿。
      墙壁上闪烁着奇异的蓝色光芒，那是发光的苔藓。
      你感觉到这里隐藏着更大的危险，但也可能有更珍贵的宝藏。
    choices:
      - text: "返回洞穴入口"
        target: "cave"
      
      - text: "探索深处"
        target: null
        action:
          type: random_event
          events:
            - chance: 35
              message: "你击败了洞穴巨魔！获得60经验值和80金币！"
              damage: 20
              exp: 60
              give_gold: 80
              give_items: [{id: "armor_001", count: 1}]
            - chance: 25
              message: "你发现了一个古老的宝箱！获得远古宝石和100金币！"
              give_items: [{id: "gem_001", count: 1}]
              give_gold: 100
            - chance: 20
              message: "暗影蝙蝠偷袭了你！失去25点HP！"
              damage: 25
            - chance: 20
              message: "你小心翼翼地探索，但没有遇到危险。"

      
      - text: "采集发光苔藓"
        target: null
        action:
          type: show_message
          message: "你采集了一些发光苔藓...（虽然没什么用，但很漂亮）"

    
    on_enter: |
      ui.show_narration("【洞穴深处】")
      ui.show_system("这里的空气更加潮湿，蓝色光芒照亮了周围...")

  # 古老遗迹
  - id: "ancient_ruins"
    name: "古老遗迹"
    description: |
      一座被时间遗忘的古代遗迹。
      巨大的石柱倒塌在地，墙壁上刻满了神秘的符文。
      中央有一座紧闭的石门，上面有一个钥匙孔。
      这里充满了神秘的气息，似乎隐藏着古老的秘密。
    choices:
      - text: "返回迷雾森林"
        target: "forest"
      
      - text: "检查石门"
        target: null
        action: |
          p = engine.get_player(engine_id)
          ui.show_system("你仔细检查了石门...")
          ui.show_system("门上刻着：'只有持有古老钥匙者，方可进入'")
          # 检查是否有钥匙
          has_key = false
          inv = player.get_inventory(p)
          for (item in inv) :
            if (item.id == "key_001") :
              has_key = true
          if (has_key) :
            ui.show_system("你使用了古老钥匙！")
            ui.show_system("石门缓缓打开，露出通往遗迹内部的通道...")
            # 这里可以设置一个标志或直接进入
            ui.show_system("（遗迹内部场景待探索）")
          else :
            ui.show_system("你需要找到古老钥匙才能打开这扇门。")
      
      - text: "研究墙壁符文"
        target: null
        action:
          type: random_event
          events:
            - chance: 15
              message: "你解读出了符文的含义！获得40经验值和神秘卷轴！"
              exp: 40
              give_items: [{id: "scroll_001", count: 1}]
            - chance: 25
              message: "你解读出了符文的含义！获得40经验值！"
              exp: 40
            - chance: 60
              message: "这些符文太古老了，你无法理解..."

      
      - text: "在遗迹中搜索"
        target: null
        action:
          type: random_event
          events:
            - chance: 25
              message: "你在废墟中发现了一些古老的硬币！"
              give_gold: 30
            - chance: 20
              message: "你发现了一块刻有符文的石板！获得25经验值！"
              exp: 25
            - chance: 10
              message: "你找到了一把古老的钥匙！"
              give_items: [{id: "key_001", count: 1}]
            - chance: 45
              message: "除了碎石和灰尘，你什么也没找到..."

    
    on_enter: |
      ui.show_narration("【古老遗迹】")
      ui.show_system("古老的符文在你靠近时微微发光...")

  # 黑暗沼泽
  - id: "dark_swamp"
    name: "黑暗沼泽"
    description: |
      一片阴森的沼泽地。
      浑浊的水面上漂浮着绿色的浮萍，空气中弥漫着腐臭的气息。
      奇怪的植物在黑暗中发出微弱的荧光。
      你听到沼泽深处传来令人不安的声音。
    choices:
      - text: "返回迷雾森林"
        target: "forest"
      
      - text: "深入沼泽"
        target: null
        action:
          type: random_event
          events:
            - chance: 30
              message: "你击败了沼泽怪！获得45经验值和发光蘑菇！"
              damage: 15
              exp: 45
              give_items: [{id: "mushroom_001", count: 2}]
            - chance: 20
              message: "你陷入了沼泽的泥潭！好不容易才爬出来，你失去了10点HP..."
              damage: 10
            - chance: 20
              message: "你发现了一片发光蘑菇群！"
              give_items: [{id: "mushroom_001", count: 3}]
            - chance: 30
              message: "沼泽中弥漫着有毒的雾气...你感觉有些不适（中毒效果需要解毒剂）"

      
      - text: "寻找稀有植物"
        target: null
        action:
          type: random_event
          events:
            - chance: 30
              message: "你发现了一株珍贵的药草！获得30经验值和月光花！"
              exp: 30
              give_items: [{id: "flower_001", count: 1}]
            - chance: 70
              message: "你只找到了一些普通的沼泽植物..."

      
      - text: "前往巨龙巢穴"
        target: "dragon_lair"
        condition: null
    
    on_enter: |
      ui.show_narration("【黑暗沼泽】")
      ui.show_system("腐臭的气息让你感到恶心...")
      ui.show_system("这里非常危险，请小心行事！")

  # 商人营地
  - id: "merchant_camp"
    name: "商人营地"
    description: |
      一个热闹的商人营地。
      各色帐篷林立，商人们叫卖着各种商品。
      这里有武器、防具、药水，还有各种稀奇古怪的东西。
      是冒险者们补给和交易的好地方。
    choices:
      - text: "返回宁静村庄"
        target: "village"
      
      - text: "购买生命药水（20金币）"
        target: null
        action:
          type: condition
          condition_type: gold_at_least
          condition_value: 20
          success:
            type: sequence
            actions:
              - type: show_message
                message: "你购买了生命药水！"
              - type: give_item
                item_id: "potion_001"
                count: 1
              - type: give_gold
                amount: -20
                message: "花费20金币"
          fail:
            type: show_message
            msg_type: dialog
            message: "商人：朋友，没钱可不行啊！"

      
      - text: "购买魔法药水（25金币）"
        target: null
        action:
          type: condition
          condition_type: gold_at_least
          condition_value: 25
          success:
            type: sequence
            actions:
              - type: show_message
                message: "你购买了魔法药水！"
              - type: give_item
                item_id: "potion_002"
                count: 1
              - type: give_gold
                amount: -25
                message: "花费25金币"
          fail:
            type: show_message
            message: "你的金币不够..."

      
      - text: "购买铁剑（120金币）"
        target: null
        action:
          type: condition
          condition_type: gold_at_least
          condition_value: 120
          success:
            type: sequence
            actions:
              - type: show_message
                message: "你购买了铁剑！攻击力大幅提升！"
              - type: give_item
                item_id: "sword_002"
                count: 1
              - type: give_gold
                amount: -120
                message: "花费120金币"
          fail:
            type: show_message
            msg_type: dialog
            message: "商人：这可是好货色，便宜不了！"

      
      - text: "购买皮甲（80金币）"
        target: null
        action:
          type: condition
          condition_type: gold_at_least
          condition_value: 80
          success:
            type: sequence
            actions:
              - type: show_message
                message: "你购买了皮甲！防御力提升！"
              - type: give_item
                item_id: "armor_001"
                count: 1
              - type: give_gold
                amount: -80
                message: "花费80金币"
          fail:
            type: show_message
            message: "你的金币不够..."

      
      - text: "出售材料"
        target: null
        action: |
          p = engine.get_player(engine_id)
          inv = player.get_inventory(p)
          
          # 统计各类材料数量
          herb_count = 0
          mushroom_count = 0
          crystal_count = 0
          flower_count = 0
          gem_count = 0
          scale_count = 0
          total_value = 0
          
          for (item in inv) :
            if (item.id == "herb_001") :
              herb_count = herb_count + 1
              total_value = total_value + 5
            elif (item.id == "mushroom_001") :
              mushroom_count = mushroom_count + 1
              total_value = total_value + 15
            elif (item.id == "crystal_001") :
              crystal_count = crystal_count + 1
              total_value = total_value + 80
            elif (item.id == "flower_001") :
              flower_count = flower_count + 1
              total_value = total_value + 40
            elif (item.id == "gem_001") :
              gem_count = gem_count + 1
              total_value = total_value + 300
            elif (item.id == "scale_001") :
              scale_count = scale_count + 1
              total_value = total_value + 500
          
          # 显示材料清单
          ui.show_system("=== 材料出售清单 ===")
          ui.show_system("草药 x" + str(herb_count) + " - 单价5金币")
          ui.show_system("发光蘑菇 x" + str(mushroom_count) + " - 单价15金币")
          ui.show_system("魔法水晶 x" + str(crystal_count) + " - 单价80金币")
          ui.show_system("月光花 x" + str(flower_count) + " - 单价40金币")
          ui.show_system("远古宝石 x" + str(gem_count) + " - 单价300金币")
          ui.show_system("龙鳞 x" + str(scale_count) + " - 单价500金币")
          ui.show_system("====================")
          ui.show_system("预计总价值：" + str(total_value) + "金币")
          
          # 执行出售
          if (total_value > 0) :
            ui.show_dialog("商人", "这些材料我全收了，给你" + str(total_value) + "金币！")

            
            # 移除所有材料并添加金币
            items_to_remove = []
            for (item in inv) :
              if (item.id == "herb_001" || item.id == "mushroom_001" || item.id == "crystal_001" || item.id == "flower_001" || item.id == "gem_001" || item.id == "scale_001") :
                items_to_remove = items_to_remove + [item]


            
            for (item in items_to_remove) :
              player.remove_item_from_inventory(p, item)
            
            player.add_gold(p, total_value)
            ui.show_system("出售成功！获得" + str(total_value) + "金币！")
            ui.show_loot("金币", total_value)

          else :
            ui.show_dialog("商人", "你身上没有可以出售的材料啊...")

      
      - text: "与商人交谈"
        target: null
        action:
          type: sequence
          actions:
            - type: show_message
              msg_type: dialog
              message: "商人：听说黑暗沼泽深处有巨龙的巢穴，里面藏着无数宝藏！"
            - type: show_message
              msg_type: dialog
              message: "商人：不过那里非常危险，建议你准备好装备再去。"
            - type: show_message
              msg_type: dialog
              message: "商人：如果你能找到龙鳞，我可以出高价收购！"

    
    on_enter: |
      ui.show_narration("【商人营地】")
      ui.show_system("商人们热情地招呼着你...")
      ui.show_dialog("商人", "欢迎欢迎！来看看有什么需要的！")

  # 巨龙巢穴
  - id: "dragon_lair"
    name: "巨龙巢穴"
    description: |
      黑暗沼泽的最深处，巨龙的巢穴。
      巨大的洞穴中堆满了金币和宝藏，散发着耀眼的光芒。
      一只巨大的红龙正趴在宝藏堆上，警惕地注视着你。
      这是最终的挑战，也是最大的机遇。
    choices:
      - text: "逃跑返回沼泽"
        target: "dark_swamp"
      
      - text: "与巨龙谈判"
        target: null
        action:
          type: sequence
          actions:
            - type: show_message
              msg_type: dialog
              message: "红龙：渺小的人类，你竟敢闯入我的巢穴？"
            - type: condition
              condition_type: random
              condition_value: 30  # 30%成功率
              success:
                type: sequence
                actions:
                  - type: show_message
                    msg_type: dialog
                    message: "红龙：你的勇气让我印象深刻...我可以给你一些金币，然后你立刻离开！"
                  - type: give_gold
                    amount: 200
                    message: "巨龙给了你 200 金币！"
              fail:
                type: sequence
                actions:
                  - type: show_message
                    msg_type: dialog
                    message: "红龙：谈判？哈哈哈！"
                  - type: damage
                    amount: 50
                    message: "巨龙攻击了你！你失去50点HP！"

      
      - text: "挑战巨龙（Boss战）"
        target: null
        action:
          type: sequence
          actions:
            - type: show_message
              message: "你鼓起勇气，向巨龙发起挑战！"
            - type: condition
              condition_type: random
              condition_value: 40  # 40%成功率
              success:
                type: sequence
                actions:
                  - type: show_message
                    msg_type: combat
                    message: "玩家最终一击！巨龙倒下了！"
                  - type: show_message
                    message: "你击败了巨龙！你成为了传说中的屠龙者！"
                  - type: give_gold
                    amount: 1000
                  - type: give_item
                    item_id: "scale_001"
                    count: 1
                  - type: show_message
                    exp: 500
                    message: "获得500经验值！=== 游戏通关！恭喜你！==="
              fail:
                type: sequence
                actions:
                  - type: show_message
                    msg_type: combat
                    message: "红龙龙息！你被击败了..."
                  - type: damage
                    amount: 80
                    message: "你受了重伤，勉强逃出了巢穴..."

      
      - text: "偷取宝藏"
        target: null
        action:
          type: sequence
          actions:
            - type: show_message
              message: "你试图悄悄偷取一些宝藏..."
            - type: condition
              condition_type: random
              condition_value: 20  # 20%成功率
              success:
                type: sequence
                actions:
                  - type: show_message
                    message: "你成功偷到了一些金币！"
                  - type: give_gold
                    amount: 100
              fail:
                type: sequence
                actions:
                  - type: show_message
                    msg_type: dialog
                    message: "红龙：小偷！"
                  - type: damage
                    amount: 40
                    message: "你被巨龙发现了！受到重创！"

    
    on_enter: |
      ui.show_narration("【巨龙巢穴】")
      ui.show_system("巨大的红龙注视着你，空气中弥漫着灼热的气息...")
      ui.show_system("这是最终的挑战！")
