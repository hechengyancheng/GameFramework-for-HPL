# 游戏工具模块 - 提供随机数生成、文本格式化等功能

classes:
  RandomGenerator:
    # 初始化随机数生成器
    init: (seed) => {
        if (seed == null) {
          seed = time.now_ms()
        }
        this.seed = seed
        this.a = 1103515245
        this.c = 12345
        this.m = 2147483647
      }
    
    # 生成随机整数 [0, max)
    random_int: (max) => {
        this.seed = (this.a * this.seed + this.c) % this.m
        return (this.seed % max + max) % max
      }
    
    # 生成随机整数 [min, max]
    random_range: (min, max) => {
        range = max - min + 1
        return this.random_int(range) + min
      }
    
    # 从数组中随机选择
    random_choice: (arr) => {
        if (len(arr) == 0) {
          return null
        }
        index = this.random_int(len(arr))
        return arr[index]
      }
    
    # 掷骰子 (n个d面骰子)
    roll_dice: (n, d) => {
        total = 0
        for (i = 0; i < n; i++) :
          total = total + this.random_range(1, d)
        return total
      }

  TextFormatter:
    # 清屏（终端）
    clear_screen: () => {
        # 使用多个换行模拟清屏
        for (i = 0; i < 50; i++) :
          echo ""
      }
    
    # 打印分隔线
    print_line: (char, length) => {
        if (char == null) {
          char = "-"
        }
        if (length == null) {
          length = 50
        }
        line = ""
        for (i = 0; i < length; i++) :
          line = line + char
        echo line
      }
    
    # 打印标题
    print_title: (text) => {
        echo ""
        this.print_line("=", 50)
        # 居中显示
        padding = (50 - len(text)) / 2
        left_pad = ""
        for (i = 0; i < padding; i++) :
          left_pad = left_pad + " "
        echo left_pad + text
        this.print_line("=", 50)
        echo ""
      }
    
    # 打印带边框的文本
    print_box: (text) => {
        length = len(text) + 4
        border = "+"
        for (i = 0; i < length - 2; i++) :
          border = border + "-"
        border = border + "+"
        echo border
        echo "| " + text + " |"
        echo border
      }
    
    # 打印列表项
    print_list_item: (index, text) => {
        echo "  [" + str(index) + "] " + text
      }
    
    # 打印进度条
    print_progress: (current, max, label) => {
        if (label == null) {
          label = "Progress"
        }
        percentage = int((current * 100) / max)
        bar_length = 20
        filled = int((current * bar_length) / max)
        bar = "["
        for (i = 0; i < filled; i++) :
          bar = bar + "#"
        for (i = filled; i < bar_length; i++) :
          bar = bar + "-"
        bar = bar + "]"
        echo label + ": " + bar + " " + str(percentage) + "%"
      }

  DiceRoller:
    # 解析骰子表达式如 "2d6+3"
    roll: (expression) => {
        # 简化实现：直接掷骰子
        # 格式: NdM 或 NdM+K 或 NdM-K
        echo "Rolling: " + expression
        return 10  # 默认返回
      }
    
    # 属性检定 (D20系统)
    ability_check: (modifier) => {
        roll = this.random_range(1, 20)
        total = roll + modifier
        echo "D20 Roll: " + str(roll) + " + " + str(modifier) + " = " + str(total)
        return total
      }
    
    # 战斗攻击检定
    attack_roll: (attack_bonus, armor_class) => {
        roll = this.random_range(1, 20)
        total = roll + attack_bonus
        if (roll == 20) {
          echo "Critical Hit! (Natural 20)"
          return "critical"
        }
        if (roll == 1) {
          echo "Critical Miss! (Natural 1)"
          return "miss"
        }
        if (total >= armor_class) {
          echo "Hit! Roll: " + str(roll) + " + " + str(attack_bonus) + " >= AC " + str(armor_class)
          return "hit"
        } else {
          echo "Miss! Roll: " + str(roll) + " + " + str(attack_bonus) + " < AC " + str(armor_class)
          return "miss"
        }
      }
    
    # 伤害骰
    damage_roll: (dice_count, dice_sides, bonus) => {
        if (bonus == null) {
          bonus = 0
        }
        total = 0
        rolls = []
        for (i = 0; i < dice_count; i++) :
          roll = this.random_range(1, dice_sides)
          rolls = rolls + [roll]
          total = total + roll
        total = total + bonus
        echo "Damage rolls: " + rolls + " + " + str(bonus) + " = " + str(total)
        return total
      }

objects:
  random_gen: RandomGenerator(time.now_ms())
  formatter: TextFormatter()
  dice: DiceRoller()
